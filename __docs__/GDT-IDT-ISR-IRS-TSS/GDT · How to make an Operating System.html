
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <title>GDT · How to make an Operating System</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.0.0">
        <meta name="author" content="Samy Pessé">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-comment/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Chapter-7/" />
    
    
    <link rel="prev" href="../Chapter-5/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://www.gitbook.com/book/samypesse/how-to-create-an-operating-system" target="_blank" class="custom-link">How to make an Operating System</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Chapter-1/">
            
                <a href="../Chapter-1/">
            
                    
                    Introduction about the x86 architecture and about our OS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Chapter-2/">
            
                <a href="../Chapter-2/">
            
                    
                    Setup the development environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Chapter-3/">
            
                <a href="../Chapter-3/">
            
                    
                    First boot with GRUB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../Chapter-4/">
            
                <a href="../Chapter-4/">
            
                    
                    Backbone of the OS and C++ runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Chapter-5/">
            
                <a href="../Chapter-5/">
            
                    
                    Base classes for managing x86 architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="./">
            
                <a href="./">
            
                    
                    GDT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../Chapter-7/">
            
                <a href="../Chapter-7/">
            
                    
                    IDT and interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Chapter-8/">
            
                <a href="../Chapter-8/">
            
                    
                    Theory: physical and virtual memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../chapter9/">
            
                <a href="../chapter9/">
            
                    
                    Memory management: physical and virtual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Process management and multitasking
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" >
            
                <span>
            
                    
                    External program execution: ELF files
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" >
            
                <span>
            
                    
                    Userland and syscalls
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Modular drivers
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
                <span>
            
                    
                    Some basics modules: console, keyboard
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" >
            
                <span>
            
                    
                    IDE Hard disks
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
                <span>
            
                    
                    DOS Partitions
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
                <span>
            
                    
                    EXT2 read-only filesystems
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" >
            
                <span>
            
                    
                    Standard C library (libC)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" >
            
                <span>
            
                    
                    UNIX basic tools: sh, cat
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" >
            
                <span>
            
                    
                    Lua interpreter
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >GDT</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="chapter-6-gdt">Chapter 6: GDT</h2>
<p>Thanks to GRUB, your kernel is no longer in real-mode, but already in <a href="http://en.wikipedia.org/wiki/Protected_mode" _target="blank">protected mode</a>, this mode allows us to use all the possibilities of the microprocessor such as virtual memory management, paging and safe multi-tasking.</p>
<h4 id="what-is-the-gdt">What is the GDT?</h4>
<p>The <a href="http://en.wikipedia.org/wiki/Global_Descriptor_Table" _target="blank">GDT</a> (&quot;Global Descriptor Table&quot;) is a data structure used to define the different memory areas: the base address, the size and access privileges like execute and write. These memory areas are called &quot;segments&quot;.</p>
<p>We are going to use the GDT to define different memory segments:</p>
<ul>
<li><em>&quot;code&quot;</em>: kernel code, used to stored the executable binary code</li>
<li><em>&quot;data&quot;</em>: kernel data</li>
<li><em>&quot;stack&quot;</em>: kernel stack, used to stored the call stack during kernel execution</li>
<li><em>&quot;ucode&quot;</em>: user code, used to stored the executable binary code for user program</li>
<li><em>&quot;udata&quot;</em>: user program data</li>
<li><em>&quot;ustack&quot;</em>: user stack, used to stored the call stack during execution in userland</li>
</ul>
<h4 id="how-to-load-our-gdt">How to load our GDT?</h4>
<p>GRUB initializes a GDT but this GDT is does not correspond to our kernel.
The GDT is loaded using the LGDT assembly instruction. It expects the location of a GDT description structure:</p>
<p><img src="gdtr.png" alt="GDTR"></p>
<p>And the C structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">struct</span> gdtr {
    u16 limite;
    u32 base;
} __attribute__ ((packed));
</code></pre>
<p><strong>Caution:</strong> the directive <code>__attribute__ ((packed))</code> signal to gcc that the structure should use as little memory as possible. Without this directive, gcc include some bytes to optimize the memory alignment and the access during execution.</p>
<p>Now we need to define our GDT table and then load it using LGDT. The GDT table can be stored wherever we want in memory, its address should just be signaled to the process using the GDTR registry.</p>
<p>The GDT table is composed of segments with the following structure:</p>
<p><img src="gdtentry.png" alt="GDTR"></p>
<p>And the C structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">struct</span> gdtdesc {
    u16 lim0_15;
    u16 base0_15;
    u8 base16_23;
    u8 acces;
    u8 lim16_19:<span class="hljs-number">4</span>;
    u8 other:<span class="hljs-number">4</span>;
    u8 base24_31;
} __attribute__ ((packed));
</code></pre>
<h4 id="how-to-define-our-gdt-table">How to define our GDT table?</h4>
<p>We need now to define our GDT in memory and finally load it using the GDTR registry.</p>
<p>We are going to store our GDT at the address:</p>
<pre><code class="lang-cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GDTBASE    0x00000800</span>
</code></pre>
<p>The function <strong>init_gdt_desc</strong> in <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/x86.cc" _target="blank">x86.cc</a> initialize a gdt segment descriptor.</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_gdt_desc</span><span class="hljs-params">(u32 base, u32 limite, u8 acces, u8 other, <span class="hljs-keyword">struct</span> gdtdesc *desc)</span>
</span>{
    desc-&gt;lim0_15 = (limite &amp; <span class="hljs-number">0xffff</span>);
    desc-&gt;base0_15 = (base &amp; <span class="hljs-number">0xffff</span>);
    desc-&gt;base16_23 = (base &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>;
    desc-&gt;acces = acces;
    desc-&gt;lim16_19 = (limite &amp; <span class="hljs-number">0xf0000</span>) &gt;&gt; <span class="hljs-number">16</span>;
    desc-&gt;other = (other &amp; <span class="hljs-number">0xf</span>);
    desc-&gt;base24_31 = (base &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span>;
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>And the function <strong>init_gdt</strong> initialize the GDT, some parts of the below function will be explained later and are used for multitasking.</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_gdt</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    default_tss.debug_flag = <span class="hljs-number">0x00</span>;
    default_tss.io_map = <span class="hljs-number">0x00</span>;
    default_tss.esp0 = <span class="hljs-number">0x1FFF0</span>;
    default_tss.ss0 = <span class="hljs-number">0x18</span>;

    <span class="hljs-comment">/* initialize gdt segments */</span>
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, &amp;kgdt[<span class="hljs-number">0</span>]);
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0xFFFFF</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">1</span>]);    <span class="hljs-comment">/* code */</span>
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0xFFFFF</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">2</span>]);    <span class="hljs-comment">/* data */</span>
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">3</span>]);        <span class="hljs-comment">/* stack */</span>

    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0xFFFFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">4</span>]);    <span class="hljs-comment">/* ucode */</span>
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0xFFFFF</span>, <span class="hljs-number">0xF3</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">5</span>]);    <span class="hljs-comment">/* udata */</span>
    init_gdt_desc(<span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0xF7</span>, <span class="hljs-number">0x0D</span>, &amp;kgdt[<span class="hljs-number">6</span>]);        <span class="hljs-comment">/* ustack */</span>

    init_gdt_desc((u32) &amp; default_tss, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xE9</span>, <span class="hljs-number">0x00</span>, &amp;kgdt[<span class="hljs-number">7</span>]);    <span class="hljs-comment">/* descripteur de tss */</span>

    <span class="hljs-comment">/* initialize the gdtr structure */</span>
    kgdtr.limite = GDTSIZE * <span class="hljs-number">8</span>;
    kgdtr.base = GDTBASE;

    <span class="hljs-comment">/* copy the gdtr to its memory area */</span>
    <span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">char</span> *) kgdtr.base, (<span class="hljs-keyword">char</span> *) kgdt, kgdtr.limite);

    <span class="hljs-comment">/* load the gdtr registry */</span>
    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;lgdtl (kgdtr)&quot;</span>);

    <span class="hljs-comment">/* initiliaz the segments */</span>
    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;   movw $0x10, %ax    \n \
            movw %ax, %ds    \n \
            movw %ax, %es    \n \
            movw %ax, %fs    \n \
            movw %ax, %gs    \n \
            ljmp $0x08, $next    \n \
            next:        \n&quot;</span>);
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../Chapter-5/" class="navigation navigation-prev " aria-label="Previous page: Base classes for managing x86 architecture">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Chapter-7/" class="navigation navigation-next " aria-label="Next page: IDT and interrupts">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"GDT","level":"1.7","depth":1,"next":{"title":"IDT and interrupts","level":"1.8","depth":1,"path":"Chapter-7/README.md","ref":"Chapter-7/README.md","articles":[]},"previous":{"title":"Base classes for managing x86 architecture","level":"1.6","depth":1,"path":"Chapter-5/README.md","ref":"Chapter-5/README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["comment"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"comment":{"highlightCommented":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"github":"SamyPesse/How-to-Make-a-Computer-Operating-System","theme":"default","author":"Samy Pessé","pdf":{"pageNumbers":true,"fontSize":16,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"How to make an Operating System","language":"en","links":{"sidebar":{"How to make an Operating System":"https://www.gitbook.com/book/samypesse/how-to-create-an-operating-system"},"gitbook":true},"gitbook":"*","description":"Learn how to write, test and run, an operating system in C++ and Assembly from scratch."},"file":{"path":"Chapter-6/README.md","mtime":"2015-10-29T19:04:29.000Z","type":"markdown"},"gitbook":{"version":"3.0.0","time":"2016-05-23T09:04:45.846Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-comment/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/buttons.js"></script>
        
    

    </body>
</html>

